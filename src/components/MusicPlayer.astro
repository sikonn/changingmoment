<div id="musicToggle">
  <img
    src="https://res.stelpolva.moe/stpv/615a661f-3b7c-4ba9-b29a-f1b8eee13979.apng"
    alt="Toggle Music"
    width="73"
    height="85"
  />
</div>

<audio id="audioPlayer" preload="auto"></audio>

<script>
  const audioPlayer = document.getElementById('audioPlayer');
  const musicToggle = document.getElementById('musicToggle');
  const totalTracks = 70;

  let currentTrack = 1;
  let clickCount = 0;
  let clickTimer;
  let isRecover = false;

  // ðŸ§  ä»ŽlocalStorageæ¢å¤æ’­æ”¾çŠ¶æ€
  const savedIndex = localStorage.getItem("musicIndex");
  const savedTime = localStorage.getItem("musicTime");
  const wasPlaying = localStorage.getItem("isPlaying") === "true";

  if (savedIndex !== null) {
    currentTrack = parseInt(savedIndex);
  } else {
    currentTrack = Math.floor(Math.random() * totalTracks) + 1;
  }

  audioPlayer.src = `/music/music${currentTrack}.m4a`;

  function playRandomTrack() {
    currentTrack = Math.floor(Math.random() * totalTracks) + 1;
    audioPlayer.src = `/music/music${currentTrack}.m4a`;
    audioPlayer.play();
  }

  musicToggle.addEventListener('click', () => {
    clickCount++;
    clearTimeout(clickTimer);

    clickTimer = setTimeout(() => {
      if (clickCount === 1) {
        audioPlayer.play();
        localStorage.setItem("isPlaying", "true");
      } else if (clickCount === 2) {
        audioPlayer.pause();
        localStorage.setItem("isPlaying", "false");
      } else if (clickCount === 3) {
        playRandomTrack();
        localStorage.setItem("isPlaying", "true");
      }
      clickCount = 0;
    }, 300);
  });

  // ðŸ§  éŸ³ä¹æ’­æ”¾å®ŒæˆåŽï¼Œè‡ªåŠ¨ä¸‹ä¸€é¦–
  audioPlayer.addEventListener('ended', () => {
    playRandomTrack();
  });

  // âœ… é¡µé¢åŠ è½½åŽï¼Œæ ¹æ®çŠ¶æ€æ¢å¤æ’­æ”¾
  audioPlayer.addEventListener("canplay", () => {
    if (!isRecover && wasPlaying) {
      if (savedTime) {
        audioPlayer.currentTime = parseFloat(savedTime);
      }
      audioPlayer.play().catch(e => {
        console.log("è‡ªåŠ¨æ¢å¤æ’­æ”¾å¤±è´¥ï¼š", e);
      });
      isRecover = true;
    }
  });

  // âœ… é¡µé¢ç¦»å¼€å‰ï¼Œä¿å­˜çŠ¶æ€
  window.addEventListener("beforeunload", () => {
    localStorage.setItem("musicIndex", currentTrack);
    localStorage.setItem("musicTime", audioPlayer.currentTime);
    localStorage.setItem("isPlaying", !audioPlayer.paused);
  });
</script>